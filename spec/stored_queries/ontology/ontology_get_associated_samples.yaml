# Get all samples reference this term

name: ontology_get_associated_samples
params:
  type: object
  required: [id, ts, "@onto_terms"]
  properties:
    id:
      type: string
      title: Document ID
      description: Ontology ID of the term you want to get all the associated samples 
    limit:
        type: integer
        default: 20
        description: Maximum result limit 
        maximum: 1000
    offset:
        type: integer
        default: 0
        description: Result offset for pagination
        maximum: 100000
    ts:
      type: integer
      title: Versioning timestamp
    "@onto_terms":
      type: string
      title: Ontology terms collection name
      description: the name of the vertex collection holding the ontology term data
      examples: [ENVO_terms, GO_terms]
query_prefix: WITH samples_nodes, samples_version, samples_sample
query: |
  LET results=(
    FOR t in @@onto_terms
      FILTER t.id == @id
      FILTER t.created <= @ts AND t.expired > @ts
      limit 1
      FOR v, e, p IN 3 OUTBOUND t INBOUND sample_ontology_link, samples_nodes_edge, samples_ver_edge
        FILTER p.vertices[1].saved * 1000 >= t.created AND p.vertices[1].saved * 1000 < t.expired
          AND p.edges[0].created * 1000 <= @ts AND p.edges[0].expired * 1000 > @ts
        SORT p.vertices[1].id ASC
        RETURN {
          sample: p.vertices[1],
          sample_metadata_key: p.edges[0].sample_metadata_term,
          sample_access: v
        }
  )
  LET total_count=COUNT(results)
  LET limited=(
    FOR r in results
      LIMIT @offset, @limit
      RETURN r
  )
  RETURN {results: limited, total_count}
